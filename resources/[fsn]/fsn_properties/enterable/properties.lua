enterable_properties = {
  [1] = {
    title = 'Darnell Bros Factory',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 1,
    blip = {x = 714.41790771484, y = -976.95068359375, z = 24.127908706665},
    rob_spot = {x = 707.25494384766, y = -966.89660644531, z = 30.412853240967},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front left door',locked=true,hash=245182344,loc={x=716.780,y=-975.420,z=25.00},text={x=716.780,y=-975.420,z=25.00}},
      [2] = {desc='front right door',locked=true,hash=-681066206,loc={x=719.381,y=-975.418,z=25.00},text={x=719.381,y=-975.418,z=25.00}},
      [3] = {desc='office front door',locked=true,hash=551491569,loc={x=709.981,y=-963.531,z=30.545},text={x=709.981,y=-963.531,z=30.545}},
      [4] = {desc='office > storage',locked=true,hash=426403179,loc={x=707.804,y=-962.456,z=30.545},text={x=707.804,y=-962.456,z=30.545}},
      [5] = {desc='storage front door',locked=true,hash=933053701,loc={x=709.989,y=-960.667,z=30.545},text={x=709.989,y=-960.667,z=30.545}},
    },
  },
  [2] = {
    title = 'Micheals Mansion',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 2,
    blip = {x = -821.80621337891, y = 174.43176269531, z = 71.542022705078},
    rob_spot = {x = -807.07531738281, y = 172.42413330078, z = 72.834754943848},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front left door',locked=true,hash=159994461,loc={x=-816.716,y=179.097,z=72.827},text={x=-816.716,y=179.097,z=72.827}},
      [2] = {desc='front right door',locked=true,hash=-1686014385,loc={x=-816.106,y=177.510,z=72.827},text={x=-816.106,y=177.510,z=72.827}},
      [3] = {desc='garage inside',locked=true,hash=-1563640173,loc={x=-806.281,y=186.024,z=72.624},text={x=-806.281,y=186.024,z=72.624}},
      [4] = {desc='rear right left',locked=true,hash=1245831483,loc={x=-794.505,y=178.012,z=73.040},text={x=-794.505,y=178.012,z=73.040}},
      [5] = {desc='rear right right',locked=true,hash=-1454760130,loc={x=-796.565,y=177.221,z=73.040},text={x=-796.565,y=177.221,z=73.040}},
      [6] = {desc='rear rear left',locked=true,hash=1245831483,loc={x=-794.185,y=182.568,z=73.040},text={x=-794.185,y=182.568,z=73.040}},
      [7] = {desc='rear rear right',locked=true,hash=-1454760130,loc={x=-793.394,y=180.507,z=73.040},text={x=-793.394,y=180.507,z=73.040}},
    },
  },
  [3] = {
    title = 'Trevors Trailer',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 3,
    blip = {x = 1979.0842285156, y = 3818.0192871094, z = 32.537998199463},
    rob_spot = {x = 1982.3674316406, y = 3053.3635253906, z = 47.215076446533},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=true,hash=132154435,loc={x=1972.768,y=3815.365,z=33.663},text={x=1972.768,y=3815.365,z=33.663}},
    },
  },
  [4] = {
    title = 'Yellowjack',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 4,
    blip = {x = 1989.6041259766, y = 3054.9001464844, z = 47.215103149414},
    rob_spot = {x = 1969.1922607422, y = 3814.564453125, z = 33.428730010986},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=true,hash=-287662406,loc={x=1991.105,y=3053.105,z=47.365},text={x=1991.105,y=3053.105,z=47.365}},
    },
  },
  [5] = {
    title = 'Shitbag\'s Flat',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 5,
    blip = {x = -1148.9720458984, y = -1523.6121826172, z = 10.628059387207},
    rob_spot = {x = -1155.1801757813, y = -1523.9296875, z = 10.632334709167},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=true,hash=-607040053,loc={x=-1149.708,y=-1521.087,z=10.782},text={x=-1149.708,y=-1521.087,z=10.782}},
    },
  },
  [6] = {
    title = 'Franklin\'s aunt house',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 6,
    blip = {x = -13.11473941803, y = -1442.2130126953, z = 31.100654602051},
    rob_spot = {x = -18.438192367554, y = -1438.5637207031, z = 31.101545333862},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=true,hash=520341586,loc={x=-14.868,y=-1441.182,z=31.193},text={x=-14.868,y=-1441.182,z=31.193}},
    },
  },
  [7] = {
    title = 'Stripclub',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 7,
    blip = {x = 127.66522216797, y = -1300.0837402344, z = 29.232746124268},
    rob_spot = {x = -18.438192367554, y = -1438.5637207031, z = 31.101545333862},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=false,hash=-1116041313,loc={x=127.955,y=-1298.503,z=29.419},text={x=127.955,y=-1298.503,z=29.419}},
      [2] = {desc='changing rooms',locked=true,hash=-495720963,loc={x=113.982,y=-1297.430,z=29.418},text={x=113.982,y=-1297.430,z=29.418}},
      [3] = {desc='office inner',locked=true,hash=-626684119,loc={x=99.083,y=-1293.700,z=29.418},text={x=99.083,y=-1293.700,z=29.418}},
      [4] = {desc='office outer',locked=true,hash=668467214,loc={x=96.091,y=-1284.853,z=29.438},text={x=96.091,y=-1284.853,z=29.438}},
    },
  },
  [8] = {
    title = 'Devins Garage',
    price = 25000,
    expiry = 0,
    owner = -1,
    coowners = {},
    db_id = 8,
    blip = {x = 484.38977050781, y = -1310.3785400391, z = 29.229318618774},
    rob_spot = {x = 472.23861694336, y = -1310.4545898438, z = 29.222127914429},
    inventory = {},
    weapons = {},
    money = 0,
    doors = {
      [1] = {desc='front door',locked=true,hash=-664582244,loc={x=482.811,y=-1311.953,z=29.350},text={x=482.811,y=-1311.953,z=29.350}},
      [2] = {desc='garage',locked=true,hash=-190780785,loc={x=484.574,y=-1315.568,z=30.250},text={x=484.574,y=-1315.568,z=30.250}},
    },
  },
}

RegisterServerEvent('fsn_properties:doors:request')
AddEventHandler('fsn_properties:doors:request', function()
  TriggerClientEvent('fsn_properties:doors:init', source, enterable_properties)
end)

RegisterServerEvent('fsn_properties:door:unlock')
AddEventHandler('fsn_properties:door:unlock', function(propertyid, doorid)
  enterable_properties[propertyid].doors[doorid].locked = false
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:door:lock')
AddEventHandler('fsn_properties:door:lock', function(propertyid, doorid)
  enterable_properties[propertyid].doors[doorid].locked = true
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:access:allow')
AddEventHandler('fsn_properties:enterable:access:allow', function(propid, pid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      table.insert(v.coowners,#v.coowners+1,pid)
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You granted ID#'..pid..' access to your property #'..propid, 'centerLeft', 8000, 'success')
      if exports.fsn_main:fsn_GetPlayerFromCharacterId(pid) ~= 0 then
        TriggerClientEvent('fsn_notify:displayNotification', exports.fsn_main:fsn_GetPlayerFromCharacterId(pid), 'You were granted access to property #'..propid, 'centerLeft', 8000, 'success')
      end

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_coowners` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.coowners)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:access:revoke')
AddEventHandler('fsn_properties:enterable:access:revoke', function(propid, pid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      for key, value in pairs(v.coowners) do
        if v == pid then
          pid_key = key
        end
      end
      table.remove(v.coowners,key)
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You removed ID#'..pid..' from your property #'..propid, 'centerLeft', 8000, 'success')
      if exports.fsn_main:fsn_GetPlayerFromCharacterId(pid) ~= 0 then
        TriggerClientEvent('fsn_notify:displayNotification', exports.fsn_main:fsn_GetPlayerFromCharacterId(pid), 'Your access to property #'..propid..' has been revoked!', 'centerLeft', 8000, 'error')
      end

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_coowners` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.coowners)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:inventory:enter')
AddEventHandler('fsn_properties:enterable:inventory:enter', function(propid, item, item_name, amt)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.inventory.item then
        v.inventory[item].amount = v.inventory.item.amount + amt
      else
        v.inventory[item] = {}
        v.inventory[item].item_name = item_name
        v.inventory[item].amount = amt
      end

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_inventory` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.inventory)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:inventory:take')
AddEventHandler('fsn_properties:enterable:inventory:take', function(propid, item, amt)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.inventory[item] then
        if v.inventory[item].amount - amt < 0 then
          TriggerClientEvent('fsn_notify:displayNotification', source, 'You dont have that many '..item, 'centerLeft', 8000, 'error')
        else
          v.inventory[item].amount = v.inventory[item].amount - amt
          if v.inventory[item].amount == 0 then
            v.inventory[item] = nil
          end
          TriggerClientEvent('fsn_inventory:item:add', source, item, amt)
        end
      else
        TriggerClientEvent('fsn_notify:displayNotification', source, 'You dont have that many', 'centerLeft', 8000, 'error')
      end

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_inventory` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.inventory)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:weapon:enter')
AddEventHandler('fsn_properties:enterable:weapon:enter', function(propid, item, item_name)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.weapons[item_name] then
        v.weapons[item_name].amount = v.weapons[item_name].amount + 1
      else
        v.weapons[item_name] = {}
        v.weapons[item_name].hashKey = item
        v.weapons[item_name].amount = 1
      end
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You stored <b>'..item_name, 'centerLeft', 8000, 'success')
      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_weapons` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.weapons)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:weapon:take')
AddEventHandler('fsn_properties:enterable:weapon:take', function(propid, item_name)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.weapons[item_name].amount == 1 then
        v.weapons[item_name] = nil
      else
         v.weapons[item_name].amount = v.weapons[item_name].amount - 1
      end
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You equipped <b>'..item_name, 'centerRight', 8000, 'success')

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_weapons` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = json.encode(v.weapons)}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:money:withdraw')
AddEventHandler('fsn_properties:enterable:money:withdraw', function(propid, amt)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.money >= amt then
        v.money = v.money - amt
        TriggerClientEvent('fsn_bank:change:walletAdd', source, amt)
      else
        TriggerClientEvent('fsn_notify:displayNotification', source, 'There is not enough money in the property!', 'centerRight', 8000, 'error')
      end

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_money` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = v.money}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:money:deposit')
AddEventHandler('fsn_properties:enterable:money:deposit', function(propid, amt)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      v.money = v.money + amt

      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_money` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = v.money}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:police:seize')
AddEventHandler('fsn_properties:enterable:police:seize', function(propid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if exports.fsn_main:fsn_GetPlayerFromCharacterId(v.owner) ~= 0 then
        TriggerClientEvent('fsn_notify:displayNotification', exports.fsn_main:fsn_GetPlayerFromCharacterId(v.owner), 'Your property #'..propid..' has been seized by the police!', 'centerLeft', 8000, 'error')
      end

      v.owner = -1
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You seized Property #'..propid, 'centerRight', 8000, 'success')

      TriggerClientEvent('chatMessage', -1, '', {255,255,255}, '^*^4:fsn_properties:^0^r '..v.title..' (#'..propid..') has been seized by the police and is available to rent.')
      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_owner` = @new WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = v.owner}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:police:empty')
AddEventHandler('fsn_properties:enterable:police:empty', function(propid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      v.money = 0
      v.inventory = {}
      v.weapons = {}
      TriggerClientEvent('fsn_notify:displayNotification', source, 'You emptied Property #'..propid, 'centerRight', 8000, 'success')

      if exports.fsn_main:fsn_GetPlayerFromCharacterId(v.owner) ~= 0 then
        TriggerClientEvent('fsn_notify:displayNotification', exports.fsn_main:fsn_GetPlayerFromCharacterId(v.owner), 'Your property #'..propid..' has been emptied by the police!', 'centerLeft', 8000, 'error')
      end
      MySQL.Async.execute('UPDATE `fsn_properties` SET `property_money` = 0, `property_inventory` = "{}", `property_weapons` = "{}" WHERE `property_id` = @id', {['@id'] = propid}, function(rowsChanged) end)
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:buy')
AddEventHandler('fsn_properties:enterable:buy', function(propid, charid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      if v.owner ~= tostring(-1) then
        v.owner = charid

        local expire = os.time() + 604800
        v.expiry = expire
        TriggerClientEvent('fsn_notify:displayNotification', source, 'You bought property #'..propid, 'centerRight', 8000, 'success')
        TriggerClientEvent('fsn_notify:displayNotification', source, 'Rent will be due in 7 days.', 'centerRight', 9000, 'info')

        TriggerClientEvent('fsn_bank:change:walletMinus', source, v.price)

        MySQL.Async.execute('UPDATE `fsn_properties` SET `property_owner` = @new, `property_expiry` = @expire WHERE `property_id` = @id', {['@id'] = propid, ['@new'] = charid, ['@expire'] = expire}, function(rowsChanged) end)
      else
        TriggerClientEvent('fsn_notify:displayNotification', source, 'Somebody already bought this!!', 'centerRight', 8000, 'error')
      end
    end
  end
  TriggerClientEvent('fsn_properties:doors:update', -1, enterable_properties)
end)

RegisterServerEvent('fsn_properties:enterable:checkRent')
AddEventHandler('fsn_properties:enterable:checkRent', function(propid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      local remaining = v.expiry - os.time()
      local remaining_days = math.ceil(remaining / 86399)
      TriggerClientEvent('chatMessage', source, '', {255,255,255}, '^*^4:fsn_properties:^0^r Rent is due in: '..remaining_days..' days')
    end
  end
end)

RegisterServerEvent('fsn_properties:enterable:payRent')
AddEventHandler('fsn_properties:enterable:payRent', function(propid)
  for k, v in pairs(enterable_properties) do
    if v.db_id == propid then
      local remaining = v.expiry - os.time()
      local remaining_days = math.ceil(remaining / 86399)
      if remaining_days > 2 then
        TriggerClientEvent('fsn_notify:displayNotification', source, 'You cannot pay rent until it is under 2 days due.', 'centerRight', 8000, 'error')
      else
        local expire = os.time() + 604800
        local ass = 86400 * remaining_days
        expire = expire + ass
        v.expiry = expire

        TriggerClientEvent('fsn_bank:change:walletMinus', source, v.price - math.ceil(v.price / 0.3))
        TriggerClientEvent('fsn_notify:displayNotification', source, 'You paid your rent', 'centerRight', 8000, 'success')

        MySQL.Async.execute('UPDATE `fsn_properties` SET `property_expiry` = @expire WHERE `property_id` = @id', {['@id'] = propid, ['@expire'] = expire}, function(rowsChanged) end)
      end
    end
  end
end)
